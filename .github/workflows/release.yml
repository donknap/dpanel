name: Release
permissions: write-all
on:
  push:
    tags:
    - 'v*'
jobs:
  build:
    strategy:
      matrix:
        platform: [ ubuntu-latest]
        go-version: [ '1.23' ]
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Test Env
        run: |
          echo "Tag name from GITHUB_REF_NAME: $GITHUB_REF_NAME"
          echo "Tag name from github.ref_name: ${{  github.ref_name }}"
          echo "Tag name from github.ref: ${{  github.ref }}"
          echo "Runs name: ${{runner.os}}"
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.MY_GITHUB_TOKEN }}
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      - name: Install dependencies
        run: |
          go get .
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          name: dpanel-builder
          driver-opts: image=moby/buildkit:master
          install: true
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Login to ALiYun
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_TOKEN }}
      - name: Prepare Toolchains
        run: |
          # GNU Toolchains
          curl -Lo arm64.tar.xz https://github.com/donknap/dpanel/releases/download/toolchains-v1/arm64.tar.xz && tar -xf arm64.tar.xz
          curl -Lo arm.tar.xz https://github.com/donknap/dpanel/releases/download/toolchains-v1/arm.tar.xz && tar -xf arm.tar.xz
          # Musl Toolchains
          curl -Lo amd64-musl.tgz https://github.com/donknap/dpanel/releases/download/toolchains-v1/amd64-musl.tgz && tar xzf amd64-musl.tgz
          curl -Lo arm64-musl.tgz https://github.com/donknap/dpanel/releases/download/toolchains-v1/arm64-musl.tgz && tar xzf arm64-musl.tgz
          curl -Lo arm-musl.tgz https://github.com/donknap/dpanel/releases/download/toolchains-v1/arm-musl.tgz && tar zxf arm-musl.tgz
          # Synology Toolchains
          curl -Lo armv8-synology.txz https://github.com/donknap/dpanel/releases/download/toolchains-v1/armv8-synology.txz && tar -Jvxf armv8-synology.txz
          curl -Lo amd64-synology.txz https://github.com/donknap/dpanel/releases/download/toolchains-v1/amd64-synology.txz && tar -Jvxf amd64-synology.txz
      - name: Docker Release & Binary Build
        run: |
          VERSION_TAG=${GITHUB_REF_NAME#v}

          # 1. 发布 CE 版 (Musl/Alpine)
          make release FAMILY=ce VERSION=${VERSION_TAG} AMD64=1 ARM64=1 ARM7=1 HUB=y LITE=0 \
            MUSL_AMD64_CC=${PWD}/x86_64-linux-musl-cross/bin/x86_64-linux-musl-gcc \
            MUSL_ARM64_CC=${PWD}/aarch64-linux-musl-cross/bin/aarch64-linux-musl-gcc \
            MUSL_ARMV7_CC=${PWD}/arm-linux-musleabihf-cross/bin/arm-linux-musleabihf-gcc

          # 2. 发布 Debian 版 (GNU)
          make release FAMILY=ce GNU=y VERSION=${VERSION_TAG} AMD64=1 ARM64=1 ARM7=1 HUB=y LITE=0 \
            GNU_AMD64_CC=gcc \
            GNU_ARM64_CC=${PWD}/arm-gnu-toolchain-13.3.rel1-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-gcc \
            GNU_ARMV7_CC=${PWD}/arm-gnu-toolchain-13.3.rel1-x86_64-arm-none-linux-gnueabihf/bin/arm-none-linux-gnueabihf-gcc

          # 3. 补充特定平台的二进制（如群晖），只需 build 不需要 release 镜像
          make build VERSION=${VERSION_TAG} PROJECT_NAME=dpanel-synology-arm64 ARM64=1 \
            ARM64_CC=${PWD}/aarch64-unknown-linux-gnu/bin/aarch64-unknown-linux-gnu-gcc
          make build VERSION=${VERSION_TAG} PROJECT_NAME=dpanel-synology-amd64 AMD64=1 \
            AMD64_CC=${PWD}/x86_64-pc-linux-gnu/bin/x86_64-pc-linux-gnu-gcc
      - name: upload artifact
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: runtime/*
          prerelease: false
  macos-build:
    strategy:
      matrix:
        platform: [ 'macos-15-intel', 'macos-latest' ]
        go-version: [ '1.23' ]
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Test Env
        run: |
          echo "Tag name from GITHUB_REF_NAME: $GITHUB_REF_NAME"
          echo "Tag name from github.ref_name: ${{  github.ref_name }}"
          echo "Tag name from github.ref: ${{  github.ref }}"
          echo "Runs name: ${{runner.os}}"
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      - name: Install dependencies
        run: |
          go get .
      - name: Build
        run: |
          VERSION_TAG=${GITHUB_REF_NAME#v}
          export CC=$(which clang)
          if [ "${{ runner.arch }}" = "X64" ]; then
            make build VERSION=${VERSION_TAG} AMD64=1 PROJECT_NAME=dpanel-darwin-amd64 AMD64_CC=$CC
          else
            make build VERSION=${VERSION_TAG} ARM64=1 PROJECT_NAME=dpanel-darwin-arm64 ARM64_CC=$CC
          fi
      - name: upload artifact
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: runtime/*
          prerelease: false
  windows-build:
    strategy:
      matrix:
        platform: [ 'windows-latest' ]
        go-version: [ '1.23' ]
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Test Env
        run: |
          echo "Tag name from GITHUB_REF_NAME: $GITHUB_REF_NAME"
          echo "Tag name from github.ref_name: ${{  github.ref_name }}"
          echo "Tag name from github.ref: ${{  github.ref }}"
          echo "Runs name: ${{runner.os}}"
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      - name: Install dependencies
        run: |
          go get .
      - name: Build
        run: |
          VERSION_TAG=${GITHUB_REF_NAME#v}
          CGO_ENABLED=1 go build -o runtime/dpanel.exe -tags ce,w7_rangine_release -ldflags "-X main.DPanelVersion=$VERSION_TAG -s -w"
        shell: bash
      - name: upload artifact
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: runtime/*
          prerelease: false
  xk-build:
    strategy:
      matrix:
        platform: [ 'ubuntu-latest' ]
        go-version: [ '1.23' ]
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Test Env
        run: |
          echo "Tag name from GITHUB_REF_NAME: $GITHUB_REF_NAME"
          echo "Tag name from github.ref_name: ${{  github.ref_name }}"
          echo "Tag name from github.ref: ${{  github.ref }}"
          echo "Runs name: ${{runner.os}}"
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.MY_GITHUB_TOKEN }}
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      - name: Install dependencies
        run: |
          go get .
      - name: Build
        run: |
          VERSION_TAG=${GITHUB_REF_NAME#v}
          make -C app/pro/tests/xk_open clean libxksssopen.so
          make clean 
          make build PROJECT_NAME=dpanel-xk-amd64 FAMILY=xk CGO_ENABLED=1 VERSION=${VERSION_TAG} AMD64=1 AMD64_CC=gcc
      - name: upload artifact
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: runtime/*
          prerelease: false
  push-tags-to-related-repos:
    needs: [ build ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dpanel-gui
        uses: actions/checkout@v4
        with:
          repository: donknap/dpanel-gui
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          path: dpanel-gui

      - name: Push tag to dpanel-gui
        working-directory: ./dpanel-gui
        run: |
          TAG=${{ github.ref_name }}
          git config user.name "donknap"
          git config user.email "donknap@gmail.com"
          git tag -f "$TAG"
          git push origin "$TAG" --force

      - name: Checkout dpanel-fnnas
        uses: actions/checkout@v4
        with:
          repository: donknap/dpanel-fnnas
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          path: dpanel-fnnas

      - name: Push tag to dpanel-fnnas
        working-directory: ./dpanel-fnnas
        run: |
          TAG=${{ github.ref_name }}
          git config user.name "donknap"
          git config user.email "donknap@gmail.com"
          git tag -f "$TAG"
          git push origin "$TAG" --force